<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title><%= pageTitle || "Marketplace" %></title>
  <link rel="stylesheet" href="/css/theme.css">
</head>
<body>

<div class="app">

  <!-- SIDEBAR -->
  <%- include("partials/sidebar", { user }) %>

  <!-- MAIN -->
  <div class="main">

    <!-- HEADER (CÓ SEARCH – CHỈ TRANG MARKETPLACE) -->
    <%- include("partials/header", { 
          pageTitle: pageTitle, 
          showSearch: true 
    }) %>

    <!-- CONTENT -->
    <main class="content">
      <div class="content-inner">

        <% if (!products || products.length === 0) { %>
          <p class="empty-text">Không có sản phẩm nào</p>
        <% } else { %>

        <div class="grid" id="productGrid">

          <% products.forEach(p => { %>
            <div class="product-card" data-name="<%= p.name.toLowerCase() %>">

              <!-- IMAGE (onerror=null prevents infinite blink loop; data URI fallback avoids 404) -->
              <div class="product-image">
                <% const imgSrc = p.imageUrl ? p.imageUrl : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22160%22 height=%22160%22%3E%3Crect fill=%22%23f3f6f4%22 width=%22160%22 height=%22160%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3ENo image%3C/text%3E%3C/svg%3E'; %>
                <img src="<%= imgSrc %>" alt="<%= p.name %>" onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22160%22 height=%22160%22%3E%3Crect fill=%22%23f3f6f4%22 width=%22160%22 height=%22160%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22%3ENo image%3C/text%3E%3C/svg%3E'">
              </div>

              <!-- INFO -->
              <div class="product-info">
                <h3><%= p.name %></h3>
                <p class="farm">Farm ID: <%= p.farmId %></p>
                <p class="price"><%= p.price %> VND</p>
              </div>

              <!-- ACTION -->
              <div class="product-actions">
                <button class="btn-outline" onclick="openProductDetail(<%= p.id %>)">
                   Xem chi tiết
                </button>
                  <button
                      class="btn-primary add-to-cart-btn"
                      data-id="<%= p.id %>"
                      data-name="<%= p.name %>"
                      data-price="<%= p.price %>"
                >
                  Thêm vào giỏ
                </button>
              </div>

            </div>
          <% }) %>

        </div>
        <% } %>

      </div>
    </main>

    <!-- FOOTER -->
    <%- include("partials/footer") %>

  </div>
</div>

<!-- PRODUCT DETAIL MODAL -->
<div class="qr-overlay" id="productDetailOverlay" onclick="closeProductDetail()">
  <div class="product-detail-modal" onclick="event.stopPropagation()">
    <button class="product-detail-close" onclick="closeProductDetail()">&times;</button>
    <div class="product-detail-content">
      <div class="product-detail-image-wrap">
        <img id="productDetailImg" src="" alt="" onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23f3f6f4%22 width=%22200%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22%3ENo image%3C/text%3E%3C/svg%3E'">
      </div>
      <div class="product-detail-info">
        <h3 id="productDetailName"></h3>
        <p class="product-detail-meta"><span id="productDetailFarm"></span></p>
        <p class="product-detail-price" id="productDetailPrice"></p>
        <p class="product-detail-desc" id="productDetailDesc"></p>
        <button class="btn-primary add-to-cart-detail" id="productDetailAddCart">
          Thêm vào giỏ
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="/js/layout.js"></script>
<script src="/js/marketplace-search.js"></script>
<script src="/js/cart.js"></script>


</body>
</html>
