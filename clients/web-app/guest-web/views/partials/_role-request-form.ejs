<form id="roleRequestForm">
    <div class="mb-3">
        <label class="form-label text-xs text-uppercase font-weight-bold text-muted">B·∫°n mu·ªën tr·ªü th√†nh?</label>
        <select class="form-select" name="requestedRole" id="roleSelect" required>
            <option value="">-- Ch·ªçn vai tr√≤ --</option>
            <option value="FARM_OWNER">üåæ Ch·ªß Trang Tr·∫°i (Farmer) - ƒêƒÉng b√°n n√¥ng s·∫£n</option>
            <option value="SHIPPER">üöö Nh√† V·∫≠n Chuy·ªÉn (Shipper) - V·∫≠n chuy·ªÉn h√†ng h√≥a</option>
            <option value="RETAILER">üè™ Nh√† B√°n L·∫ª (Retailer) - Mua bu√¥n ph√¢n ph·ªëi</option>
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label text-xs text-uppercase font-weight-bold text-muted">
            Gi·∫•y t·ªù x√°c th·ª±c <span class="text-danger">*</span>
        </label>
        <p class="text-muted small mb-2">
            T·∫£i l√™n ·∫£nh Gi·∫•y ph√©p kinh doanh, CMND/CCCD ho·∫∑c gi·∫•y t·ªù ch·ª©ng minh b·∫°n ƒë·ªß ƒëi·ªÅu ki·ªán.
        </p>
        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('licenseInput').click()">
            <i class="material-symbols-rounded text-muted mb-2" style="font-size: 3rem;">cloud_upload</i>
            <p class="mb-1">Nh·∫•n ho·∫∑c k√©o th·∫£ file v√†o ƒë√¢y</p>
            <small class="text-muted">PNG, JPG, PDF (t·ªëi ƒëa 5MB)</small>
            <input type="file" id="licenseInput" name="businessLicense" accept="image/*,.pdf" style="display: none;" onchange="previewFile(this)">
        </div>
        <div id="filePreview" class="mt-3" style="display: none;">
            <div class="d-flex align-items-center p-2 bg-light rounded">
                <i class="material-symbols-rounded text-success me-2">description</i>
                <span id="fileName" class="flex-grow-1 text-sm"></span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile()">
                    <i class="material-symbols-rounded text-sm">close</i>
                </button>
            </div>
            <img id="imagePreview" src="" class="img-fluid mt-2 rounded" style="max-height: 200px; display: none;">
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label text-xs text-uppercase font-weight-bold text-muted">Ghi ch√∫ (t√πy ch·ªçn)</label>
        <textarea class="form-control" name="note" rows="2" placeholder="Th√™m th√¥ng tin b·ªï sung n·∫øu c·∫ßn..."></textarea>
    </div>

    <div class="alert alert-info border-0 small" role="alert" style="border-radius: 0.75rem;">
        <i class="material-symbols-rounded align-middle me-1">info</i>
        Y√™u c·∫ßu s·∫Ω ƒë∆∞·ª£c Admin xem x√©t trong v√≤ng 24-48 gi·ªù. K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c th√¥ng b√°o qua email.
    </div>

    <button type="submit" class="btn btn-bicap w-100">
        <i class="material-symbols-rounded me-1">send</i> G·ª≠i y√™u c·∫ßu x√©t duy·ªát
    </button>
</form>

<script>
    // Drag & Drop
    const uploadZone = document.getElementById('uploadZone');
    
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) {
            document.getElementById('licenseInput').files = e.dataTransfer.files;
            previewFile(document.getElementById('licenseInput'));
        }
    });

    // Preview file
    function previewFile(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('filePreview').style.display = 'block';
            uploadZone.style.display = 'none';
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('imagePreview').style.display = 'none';
            }
        }
    }

    function removeFile() {
        document.getElementById('licenseInput').value = '';
        document.getElementById('filePreview').style.display = 'none';
        document.getElementById('uploadZone').style.display = 'block';
    }

    // Submit form
    document.getElementById('roleRequestForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('licenseInput');
        if (fileInput.files.length === 0) {
            alert('Vui l√≤ng t·∫£i l√™n gi·∫•y t·ªù x√°c th·ª±c!');
            return;
        }
        
        const roleSelect = document.getElementById('roleSelect');
        if (!roleSelect.value) {
            alert('Vui l√≤ng ch·ªçn vai tr√≤ mu·ªën ƒëƒÉng k√Ω!');
            return;
        }
        
        // Convert file to base64
        const reader = new FileReader();
        reader.readAsDataURL(fileInput.files[0]);
        reader.onload = async function() {
            const payload = {
                requestedRole: roleSelect.value,
                documentUrls: reader.result // Base64 string
            };
            
            try {
                const res = await fetch('/api/v1/role-requests/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();
                if (res.ok) {
                    alert('ƒê√£ g·ª≠i y√™u c·∫ßu th√†nh c√¥ng! Vui l√≤ng ch·ªù Admin x√©t duy·ªát.');
                    window.location.reload();
                } else {
                    alert('L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu'));
                }
            } catch (err) {
                console.error(err);
                alert('L·ªói k·∫øt n·ªëi server');
            }
        };
    });
</script>
